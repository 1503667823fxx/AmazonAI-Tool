import streamlit as st
import replicate
import google.generativeai as genai
from PIL import Image
import io

# --- 1. é¡µé¢é…ç½® ---
st.set_page_config(page_title="è§†è§‰å·¥åœº", page_icon="ğŸ¨", layout="wide")

# è‡ªå®šä¹‰æ ·å¼
st.markdown("""
<style>
    .stButton button {width: 100%;}
    .stImage {border-radius: 10px;}
</style>
""", unsafe_allow_html=True)

# --- 2. éªŒè¯ Keys ---
if "REPLICATE_API_TOKEN" not in st.secrets:
    st.error("âŒ æœªæ‰¾åˆ° Replicate API Tokenï¼Œè¯·åœ¨ Secrets ä¸­é…ç½®ï¼")
    st.stop()
if "GOOGLE_API_KEY" not in st.secrets:
    st.warning("âš ï¸ æœªæ‰¾åˆ° Google API Keyï¼Œæ™ºèƒ½ä¼˜åŒ–æç¤ºè¯åŠŸèƒ½å°†ä¸å¯ç”¨ã€‚")
else:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])

# --- 3. ä¾§è¾¹æ é…ç½® ---
with st.sidebar:
    st.title("ğŸ¨ ç»˜å›¾å‚æ•°è®¾ç½®")
    
    # æ¨¡å‹é€‰æ‹© (FLUX 1.1 Pro æ˜¯ç›®å‰æœ€å¼ºæœ€å¿«çš„)
    model_version = "black-forest-labs/flux-1.1-pro"
    
    aspect_ratio = st.selectbox(
        "å›¾ç‰‡æ¯”ä¾‹ (Aspect Ratio)",
        ["1:1 (ç”µå•†ä¸»å›¾)", "16:9 (Banner/æµ·æŠ¥)", "9:16 (TikTok/Reels)", "4:3", "3:2"]
    )
    
    output_format = st.selectbox("è¾“å‡ºæ ¼å¼", ["webp", "jpg", "png"])
    safety_tolerance = st.slider("å®‰å…¨è¿‡æ»¤ç­‰çº§ (è¶Šä½è¶Šä¸¥)", 1, 5, 2)

# --- 4. æ ¸å¿ƒé€»è¾‘ ---
st.title("ğŸ¨ AI è§†è§‰å·¥åœº (Visual Studio)")
st.caption("Powered by FLUX.1 Pro + Gemini 3.0 Brain")

col1, col2 = st.columns([4, 6])

with col1:
    st.subheader("1. åˆ›æ„è¾“å…¥")
    
    # A. åŸºç¡€è¾“å…¥
    raw_prompt = st.text_area(
        "æè¿°ä½ æƒ³è¦çš„ç”»é¢ (æ”¯æŒä¸­æ–‡)", 
        placeholder="ä¾‹å¦‚ï¼šä¸€ä¸ªç™½è‰²çš„é™¶ç“·å’–å•¡æ¯æ”¾åœ¨æœ¨è´¨æ¡Œé¢ä¸Šï¼Œæ—è¾¹æœ‰å’–å•¡è±†ï¼Œæ¸…æ™¨é˜³å…‰ï¼Œé«˜åˆ†è¾¨ç‡...",
        height=100
    )
    
    # B. æ™ºèƒ½ä¼˜åŒ–æŒ‰é’® (Gemini)
    if st.button("âœ¨ ç”¨ Gemini ä¼˜åŒ–æç¤ºè¯ (å˜ä¸“ä¸š)", type="secondary"):
        if not raw_prompt:
            st.warning("è¯·å…ˆè¾“å…¥ä¸€äº›ç®€å•çš„æè¿°ï¼")
        else:
            with st.spinner("Gemini æ­£åœ¨æ„æ€å…‰å½±å’Œæ„å›¾..."):
                try:
                    # è°ƒç”¨ Gemini æ¶¦è‰²
                    g_model = genai.GenerativeModel('gemini-3-pro-preview') # æˆ–è€… gemini-1.5-pro
                    g_prompt = f"""
                    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIç»˜å›¾æç¤ºè¯å·¥ç¨‹å¸ˆ (Prompt Engineer)ã€‚
                    è¯·æŠŠç”¨æˆ·çš„è¿™ä¸ªç®€å•æè¿°ï¼š"{raw_prompt}"
                    æ”¹å†™æˆä¸€ä¸ª FLUX æ¨¡å‹èƒ½å¬æ‡‚çš„ã€é«˜è´¨é‡çš„è‹±æ–‡ Promptã€‚
                    
                    è¦æ±‚ï¼š
                    1. å¢åŠ å…‰å½±ã€æè´¨ã€é•œå¤´å‚æ•°ï¼ˆå¦‚ 8k, photorealistic, cinematic lightingï¼‰ã€‚
                    2. å¦‚æœç”¨æˆ·æåˆ°äº†äº§å“ä¸Šçš„æ–‡å­—ï¼Œè¯·ç”¨åŒå¼•å·æ˜ç¡®æ ‡æ³¨ï¼Œä¾‹å¦‚ text "COFFEE"ã€‚
                    3. ç›´æ¥è¾“å‡ºè‹±æ–‡ Promptï¼Œä¸è¦ä»»ä½•è§£é‡Šã€‚
                    """
                    response = g_model.generate_content(g_prompt)
                    optimized_prompt = response.text
                    
                    # å­˜å…¥ Session State ä»¥ä¾¿æ˜¾ç¤º
                    st.session_state['final_prompt'] = optimized_prompt
                    st.success("ä¼˜åŒ–å®Œæˆï¼å·²è‡ªåŠ¨å¡«å…¥ä¸‹æ–¹ã€‚")
                except Exception as e:
                    st.error(f"Gemini ä¼˜åŒ–å¤±è´¥: {e}")

    # C. æœ€ç»ˆæç¤ºè¯ (å‘é€ç»™ FLUX çš„)
    # å¦‚æœ Session ä¸­æœ‰ä¼˜åŒ–è¿‡çš„è¯ï¼Œå°±ç”¨ä¼˜åŒ–è¿‡çš„ï¼Œå¦åˆ™ç”¨åŸæœ¬çš„
    default_prompt = st.session_state.get('final_prompt', raw_prompt)
    final_prompt = st.text_area(
        "æœ€ç»ˆè‹±æ–‡ Prompt (å¯æ‰‹åŠ¨å¾®è°ƒ)", 
        value=default_prompt,
        height=150,
        help="è¿™æ˜¯å®é™…å‘é€ç»™ç»˜å›¾æ¨¡å‹çš„æŒ‡ä»¤ï¼Œå¿…é¡»æ˜¯è‹±æ–‡ã€‚"
    )

with col2:
    st.subheader("2. ç”Ÿæˆç»“æœ")
    
    generate_btn = st.button("ğŸš€ å¼€å§‹ç»˜å›¾ (Run FLUX)", type="primary")
    
    if generate_btn:
        if not final_prompt:
            st.warning("æç¤ºè¯ä¸èƒ½ä¸ºç©ºï¼")
        else:
            with st.spinner("ğŸ¨ FLUX æ­£åœ¨æ¸²æŸ“åƒç´ ... (çº¦éœ€ 5-10ç§’)"):
                try:
                    # è°ƒç”¨ Replicate
                    output = replicate.run(
                        model_version,
                        input={
                            "prompt": final_prompt,
                            "aspect_ratio": aspect_ratio.split(" ")[0], # æå– 1:1
                            "output_format": output_format,
                            "output_quality": 90,
                            "safety_tolerance": safety_tolerance
                        }
                    )
                    
                    # FLUX 1.1 Pro è¿”å›çš„æ˜¯ä¸€ä¸ªæ–‡ä»¶æµå¯¹è±¡æˆ– URL
                    # é€šå¸¸ output å°±æ˜¯ä¸€ä¸ª image url
                    image_url = str(output)
                    
                    st.image(image_url, caption="Generated by FLUX.1 Pro", use_column_width=True)
                    st.success("âœ… ç”ŸæˆæˆåŠŸï¼å³é”®å¯å¦å­˜ä¸ºå›¾ç‰‡ã€‚")
                    
                    # æ˜¾ç¤ºä¸‹è½½é“¾æ¥
                    st.markdown(f"[ğŸ“¥ ç‚¹å‡»ä¸‹è½½åŸå›¾]({image_url})")
                    
                except Exception as e:
                    st.error(f"ç»˜å›¾å¤±è´¥: {e}")
                    st.info("ğŸ’¡ æç¤ºï¼šè¯·æ£€æŸ¥ Replicate ä½™é¢æˆ– API Token æ˜¯å¦æ­£ç¡®ã€‚")

st.markdown("---")
st.info("ğŸ’¡ å°æŠ€å·§ï¼šå¦‚æœä½ æƒ³åœ¨äº§å“ä¸Šå°å­—ï¼Œè¯·åœ¨æç¤ºè¯é‡Œå†™ï¼štext \"YOUR TEXT\"")
